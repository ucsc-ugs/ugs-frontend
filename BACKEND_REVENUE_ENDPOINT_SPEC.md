# Backend Revenue Endpoint Specification

## Issue
The Revenue Dashboard (`/src/pages/superAdmin/Revenue.tsx`) is encountering the following error:

```
Call to a member function isSuperAdmin() on null
```

This indicates that the backend endpoint either:
1. Doesn't exist yet
2. Has authentication middleware that isn't properly retrieving the authenticated user
3. Is trying to call `isSuperAdmin()` on a null user object

## Required Backend Implementation

### Endpoint Details
- **URL:** `GET /api/admin/revenue`
- **Query Parameters:** `range` (optional, default: "all_time")
  - Possible values: `last_7_days`, `last_30_days`, `last_quarter`, `last_year`, `all_time`
- **Authentication:** Super Admin Bearer Token (via `Authorization: Bearer {token}`)
- **Content-Type:** `application/json`

### Authentication Middleware Fix

The middleware should:
1. Extract the bearer token from the Authorization header
2. Validate the token and retrieve the user
3. **Check if user exists before calling methods on it**
4. Verify the user has super admin privileges

Example Laravel middleware pattern:
```php
public function handle($request, Closure $next)
{
    $user = auth('sanctum')->user();
    
    // IMPORTANT: Check if user exists before calling methods
    if (!$user) {
        return response()->json(['message' => 'Unauthenticated'], 401);
    }
    
    if (!$user->isSuperAdmin()) {
        return response()->json(['message' => 'Unauthorized'], 403);
    }
    
    return $next($request);
}
```

### Response Format

The endpoint must return JSON in the following structure:

```json
{
  "total_revenue": 150000.00,
  "total_commission": 15000.00,
  "organization_revenues": [
    {
      "id": 1,
      "name": "University of Colombo",
      "revenue": 50000.00,
      "commission": 5000.00,
      "exam_count": 10
    }
  ],
  "exam_revenues": [
    {
      "id": 1,
      "name": "Mathematics Entrance Exam",
      "organization_name": "University of Colombo",
      "revenue": 25000.00,
      "commission": 2500.00,
      "attempt_count": 150
    }
  ],
  "monthly_revenues": [
    {
      "month": "2024-01",
      "revenue": 12000.00,
      "commission": 1200.00
    },
    {
      "month": "2024-02",
      "revenue": 15000.00,
      "commission": 1500.00
    }
  ]
}
```

### Field Descriptions

#### Root Level
- `total_revenue` (number): Sum of all revenue across all organizations
- `total_commission` (number): Sum of all commissions taken by the platform

#### organization_revenues (array)
- `id` (number): Organization ID
- `name` (string): Organization name
- `revenue` (number): Total revenue generated by this organization
- `commission` (number): Total commission from this organization
- `exam_count` (number): Number of exams created by this organization

#### exam_revenues (array)
- `id` (number): Exam ID
- `name` (string): Exam name
- `organization_name` (string): Name of the organization that owns this exam
- `revenue` (number): Total revenue from this exam
- `commission` (number): Total commission from this exam
- `attempt_count` (number): Number of paid attempts for this exam

#### monthly_revenues (array)
- `month` (string): Month in YYYY-MM format
- `revenue` (number): Total revenue for that month
- `commission` (number): Total commission for that month

## Example Laravel Controller Implementation

```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;

class RevenueController extends Controller
{
    public function index(Request $request)
    {
        $range = $request->query('range', 'all_time');
        
        // Determine date range
        $startDate = $this->getStartDate($range);
        
        // Calculate total revenue and commission
        $totals = DB::table('payments')
            ->when($startDate, function ($query) use ($startDate) {
                return $query->where('created_at', '>=', $startDate);
            })
            ->where('status', 'completed')
            ->selectRaw('
                SUM(amount) as total_revenue,
                SUM(commission) as total_commission
            ')
            ->first();
        
        // Revenue by organization
        $organizationRevenues = DB::table('payments')
            ->join('exams', 'payments.exam_id', '=', 'exams.id')
            ->join('organizations', 'exams.organization_id', '=', 'organizations.id')
            ->when($startDate, function ($query) use ($startDate) {
                return $query->where('payments.created_at', '>=', $startDate);
            })
            ->where('payments.status', 'completed')
            ->groupBy('organizations.id', 'organizations.name')
            ->selectRaw('
                organizations.id,
                organizations.name,
                SUM(payments.amount) as revenue,
                SUM(payments.commission) as commission,
                COUNT(DISTINCT exams.id) as exam_count
            ')
            ->get();
        
        // Revenue by exam
        $examRevenues = DB::table('payments')
            ->join('exams', 'payments.exam_id', '=', 'exams.id')
            ->join('organizations', 'exams.organization_id', '=', 'organizations.id')
            ->when($startDate, function ($query) use ($startDate) {
                return $query->where('payments.created_at', '>=', $startDate);
            })
            ->where('payments.status', 'completed')
            ->groupBy('exams.id', 'exams.name', 'organizations.name')
            ->selectRaw('
                exams.id,
                exams.name,
                organizations.name as organization_name,
                SUM(payments.amount) as revenue,
                SUM(payments.commission) as commission,
                COUNT(payments.id) as attempt_count
            ')
            ->get();
        
        // Monthly revenue trends
        $monthlyRevenues = DB::table('payments')
            ->when($startDate, function ($query) use ($startDate) {
                return $query->where('created_at', '>=', $startDate);
            })
            ->where('status', 'completed')
            ->groupBy('month')
            ->selectRaw("
                DATE_FORMAT(created_at, '%Y-%m') as month,
                SUM(amount) as revenue,
                SUM(commission) as commission
            ")
            ->orderBy('month', 'asc')
            ->get();
        
        return response()->json([
            'total_revenue' => $totals->total_revenue ?? 0,
            'total_commission' => $totals->total_commission ?? 0,
            'organization_revenues' => $organizationRevenues,
            'exam_revenues' => $examRevenues,
            'monthly_revenues' => $monthlyRevenues,
        ]);
    }
    
    private function getStartDate($range)
    {
        return match($range) {
            'last_7_days' => Carbon::now()->subDays(7),
            'last_30_days' => Carbon::now()->subDays(30),
            'last_quarter' => Carbon::now()->subMonths(3),
            'last_year' => Carbon::now()->subYear(),
            default => null, // all_time
        };
    }
}
```

## Routes Configuration

Add to your `routes/api.php`:

```php
// Super Admin Routes
Route::prefix('admin')->middleware(['auth:sanctum', 'super_admin'])->group(function () {
    // ... existing routes ...
    
    Route::get('/revenue', [RevenueController::class, 'index']);
});
```

## Testing the Endpoint

```bash
# Test with a valid super admin token
curl -X GET "http://localhost:8000/api/admin/revenue?range=all_time" \
  -H "Authorization: Bearer YOUR_SUPER_ADMIN_TOKEN" \
  -H "Accept: application/json"
```

## Frontend Integration Status

✅ Frontend component created and configured  
✅ API helper function added to `superAdminApi.ts`  
✅ Error handling implemented  
⏳ **Waiting for backend endpoint implementation**

---

**Note:** Once the backend endpoint is implemented and the authentication middleware is fixed, the Revenue Dashboard should work immediately without any frontend changes.
